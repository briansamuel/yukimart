<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <title>Quick Order Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Toastr CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .test-pass { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .test-fail { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .test-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h1 class="text-center my-4">Quick Order System Test</h1>
        
        <!-- Test Results Container -->
        <div id="testResults"></div>
        
        <!-- Test Controls -->
        <div class="test-section">
            <h3>Test Controls</h3>
            <button class="btn btn-primary" onclick="runAllTests()">Run All Tests</button>
            <button class="btn btn-secondary" onclick="clearResults()">Clear Results</button>
            <button class="btn btn-info" onclick="showSystemInfo()">System Info</button>
        </div>
        
        <!-- Mock Quick Order Container -->
        <div id="mockQuickOrder" style="display: none;">
            <div class="quick-order-container">
                <div class="quick-order-header">
                    <div class="header-right">
                        <div class="barcode-input-container">
                            <input type="text" id="barcodeInput" class="barcode-input">
                            <div class="product-suggestions" id="productSuggestions"></div>
                        </div>
                        <div class="order-tabs" id="orderTabsContainer"></div>
                    </div>
                </div>
                <div class="quick-order-content">
                    <div id="orderTabsContent"></div>
                </div>
            </div>
            
            <!-- Mock Template -->
            <div id="orderTabTemplate" style="display: none;">
                <div class="tab-content-mock">
                    <div class="order-items-list"></div>
                    <input type="hidden" id="customerSelect">
                    <input type="text" id="customerSearch">
                    <div id="customerSuggestions"></div>
                    <button id="createOrderBtn">Create Order</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Toastr JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    
    <script>
        // Mock data for testing
        window.defaultBranchShop = { id: 1, name: 'Chi nhánh chính' };
        window.bankAccounts = [
            { id: 1, bank_name: 'Vietcombank', account_number: '1234567890', account_holder: 'Test Account', is_default: true }
        ];
        window.customers = [
            { id: 1, name: 'Nguyễn Văn A', phone: '0123456789', customer_code: 'KH001' },
            { id: 2, name: 'Trần Thị B', phone: '0987654321', customer_code: 'KH002' }
        ];
        window.sellers = [
            { id: 1, name: 'Seller 1', full_name: 'Nhân viên 1' }
        ];
        
        // Mock CSRF token
        $('head').append('<meta name="csrf-token" content="test-token">');
        
        // Test functions
        let testResults = [];
        
        function addTestResult(testName, passed, message) {
            const result = {
                name: testName,
                passed: passed,
                message: message,
                timestamp: new Date().toLocaleTimeString()
            };
            testResults.push(result);
            displayTestResult(result);
        }
        
        function displayTestResult(result) {
            const resultClass = result.passed ? 'test-pass' : 'test-fail';
            const icon = result.passed ? 'fa-check-circle' : 'fa-times-circle';
            
            const html = `
                <div class="test-result ${resultClass}">
                    <i class="fas ${icon}"></i>
                    <strong>${result.name}</strong> - ${result.message}
                    <small class="float-end">${result.timestamp}</small>
                </div>
            `;
            
            $('#testResults').append(html);
        }
        
        function clearResults() {
            $('#testResults').empty();
            testResults = [];
        }
        
        function showSystemInfo() {
            const info = `
                <div class="test-result test-info">
                    <h5>System Information</h5>
                    <ul>
                        <li>jQuery Version: ${$.fn.jquery}</li>
                        <li>Bootstrap: ${typeof bootstrap !== 'undefined' ? 'Loaded' : 'Not Loaded'}</li>
                        <li>Toastr: ${typeof toastr !== 'undefined' ? 'Loaded' : 'Not Loaded'}</li>
                        <li>Default Branch: ${window.defaultBranchShop ? window.defaultBranchShop.name : 'Not Set'}</li>
                        <li>Customers Count: ${window.customers ? window.customers.length : 0}</li>
                        <li>Bank Accounts Count: ${window.bankAccounts ? window.bankAccounts.length : 0}</li>
                    </ul>
                </div>
            `;
            $('#testResults').append(info);
        }
        
        // Test 1: Check if required libraries are loaded
        function testLibrariesLoaded() {
            const jqueryLoaded = typeof $ !== 'undefined';
            const bootstrapLoaded = typeof bootstrap !== 'undefined';
            const toastrLoaded = typeof toastr !== 'undefined';
            
            addTestResult('Libraries Check', jqueryLoaded && bootstrapLoaded && toastrLoaded, 
                `jQuery: ${jqueryLoaded}, Bootstrap: ${bootstrapLoaded}, Toastr: ${toastrLoaded}`);
        }
        
        // Test 2: Check if mock data is available
        function testMockData() {
            const hasDefaultBranch = window.defaultBranchShop && window.defaultBranchShop.id;
            const hasCustomers = window.customers && window.customers.length > 0;
            const hasBankAccounts = window.bankAccounts && window.bankAccounts.length > 0;
            
            addTestResult('Mock Data Check', hasDefaultBranch && hasCustomers && hasBankAccounts,
                `Branch: ${hasDefaultBranch}, Customers: ${hasCustomers}, Banks: ${hasBankAccounts}`);
        }
        
        // Test 3: Check if DOM elements exist
        function testDOMElements() {
            const hasBarcodeInput = $('#barcodeInput').length > 0;
            const hasTabsContainer = $('#orderTabsContainer').length > 0;
            const hasTabTemplate = $('#orderTabTemplate').length > 0;
            
            addTestResult('DOM Elements Check', hasBarcodeInput && hasTabsContainer && hasTabTemplate,
                `Barcode Input: ${hasBarcodeInput}, Tabs Container: ${hasTabsContainer}, Template: ${hasTabTemplate}`);
        }
        
        // Test 4: Test currency formatting
        function testCurrencyFormatting() {
            try {
                // Mock formatCurrency function
                window.formatCurrency = function(amount) {
                    return new Intl.NumberFormat('vi-VN', {
                        style: 'currency',
                        currency: 'VND'
                    }).format(amount);
                };
                
                const result = formatCurrency(100000);
                const expected = '100.000 ₫';
                const passed = result.includes('100') && result.includes('₫');
                
                addTestResult('Currency Formatting', passed, `Result: ${result}`);
            } catch (error) {
                addTestResult('Currency Formatting', false, `Error: ${error.message}`);
            }
        }
        
        // Test 5: Test localStorage functionality
        function testLocalStorage() {
            try {
                const testData = { test: 'data', timestamp: new Date().toISOString() };
                localStorage.setItem('quickOrderTest', JSON.stringify(testData));
                
                const retrieved = JSON.parse(localStorage.getItem('quickOrderTest'));
                const passed = retrieved && retrieved.test === 'data';
                
                localStorage.removeItem('quickOrderTest');
                addTestResult('LocalStorage Test', passed, passed ? 'Can save and retrieve data' : 'Failed to save/retrieve');
            } catch (error) {
                addTestResult('LocalStorage Test', false, `Error: ${error.message}`);
            }
        }
        
        // Test 6: Test global variables initialization
        function testGlobalVariables() {
            // Mock global variables
            window.orderTabs = [];
            window.activeTabId = null;
            window.tabCounter = 0;
            
            const hasOrderTabs = Array.isArray(window.orderTabs);
            const hasActiveTabId = window.activeTabId === null;
            const hasTabCounter = typeof window.tabCounter === 'number';
            
            addTestResult('Global Variables', hasOrderTabs && hasActiveTabId && hasTabCounter,
                `orderTabs: ${hasOrderTabs}, activeTabId: ${hasActiveTabId}, tabCounter: ${hasTabCounter}`);
        }
        
        // Test 7: Test event binding
        function testEventBinding() {
            try {
                let eventFired = false;
                
                // Test click event
                $('#barcodeInput').on('test-event', function() {
                    eventFired = true;
                });
                
                $('#barcodeInput').trigger('test-event');
                
                addTestResult('Event Binding', eventFired, eventFired ? 'Events can be bound and triggered' : 'Event binding failed');
            } catch (error) {
                addTestResult('Event Binding', false, `Error: ${error.message}`);
            }
        }
        
        // Test 8: Test AJAX setup (mock)
        function testAjaxSetup() {
            try {
                const csrfToken = $('meta[name="csrf-token"]').attr('content');
                const hasCSRF = csrfToken && csrfToken.length > 0;
                
                // Test jQuery AJAX availability
                const hasAjax = typeof $.ajax === 'function';
                
                addTestResult('AJAX Setup', hasCSRF && hasAjax, 
                    `CSRF Token: ${hasCSRF}, jQuery AJAX: ${hasAjax}`);
            } catch (error) {
                addTestResult('AJAX Setup', false, `Error: ${error.message}`);
            }
        }
        
        // Run all tests
        function runAllTests() {
            clearResults();
            
            addTestResult('Test Suite Started', true, 'Running all tests...');
            
            setTimeout(() => testLibrariesLoaded(), 100);
            setTimeout(() => testMockData(), 200);
            setTimeout(() => testDOMElements(), 300);
            setTimeout(() => testCurrencyFormatting(), 400);
            setTimeout(() => testLocalStorage(), 500);
            setTimeout(() => testGlobalVariables(), 600);
            setTimeout(() => testEventBinding(), 700);
            setTimeout(() => testAjaxSetup(), 800);
            
            setTimeout(() => {
                const passedTests = testResults.filter(r => r.passed).length;
                const totalTests = testResults.length - 1; // Exclude "Test Suite Started"
                
                addTestResult('Test Suite Completed', true, 
                    `${passedTests}/${totalTests} tests passed`);
            }, 1000);
        }
        
        // Auto-run tests on page load
        $(document).ready(function() {
            showSystemInfo();
            
            // Add some helpful info
            $('#testResults').append(`
                <div class="test-result test-info">
                    <h5>Quick Order Test Suite</h5>
                    <p>This test page verifies that the Quick Order system components are working correctly.</p>
                    <p>Click "Run All Tests" to start the test suite.</p>
                </div>
            `);
        });
    </script>
</body>
</html>
